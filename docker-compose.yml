# Docker Compose for Local Development
#
# Usage:
#   - Make sure you have Docker installed.
#   - Create a .env file from .env.example and fill in the values.
#   - Run `docker-compose up --build` to start all services.

version: '3.8'

services:
  # Backend API (FastAPI)
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./services/api:/app
    env_file:
      - .env
    depends_on:
      - db
      - redis
      - qdrant
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Background Workers (Celery)
  worker:
    build:
      context: ./services/workers
      dockerfile: Dockerfile
    volumes:
      - ./services/workers:/app
    env_file:
      - .env
    depends_on:
      - redis
      - qdrant
      - db
    command: celery -A app.tasks.celery worker --loglevel=info

  # Database (PostgreSQL + pgvector)
  db:
    image: supabase/postgres:15.1.0.118
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Vector Store (Qdrant)
  qdrant:
    image: qdrant/qdrant:v1.7.4
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage

  # Task Broker (Redis)
  redis:
    image: valkey/valkey:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # Web Frontend (Next.js) - Run this locally for better hot-reloading
  # To run the web app, navigate to `apps/web` and run `pnpm dev`
  # This service is commented out as it's often better to run the Node server on the host.
  # web:
  #   build:
  #     context: ./apps/web
  #     dockerfile: Dockerfile
  #   ports:
  - "3000:3000"
  #   volumes:
  #     - ./apps/web:/app
  #     - /app/node_modules # Prevent host node_modules from overwriting container
  #   env_file:
  #     - .env

volumes:
  postgres_data:
  qdrant_data:
  redis_data:
