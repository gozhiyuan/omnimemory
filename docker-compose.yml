# Docker Compose for Local Development
#
# Usage:
#   - Copy .env.example to .env and fill in values
#   - Run `make dev-up` to start infrastructure services
#   - Run API/worker/frontend locally on host for hot-reload
#
# Services: Postgres, Redis, Qdrant, RustFS (S3), Authentik (OIDC), Prometheus, Grafana

services:
  postgres:
    image: postgres:15-alpine
    container_name: lifelog-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-lifelog}
      - POSTGRES_USER=${POSTGRES_USER:-lifelog}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-lifelog}
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-lifelog}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: valkey/valkey:7-alpine
    container_name: lifelog-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli ping || redis-cli ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  authentik-db:
    image: postgres:15-alpine
    container_name: lifelog-authentik-db
    environment:
      - POSTGRES_DB=${AUTHENTIK_POSTGRES_DB:-authentik}
      - POSTGRES_USER=${AUTHENTIK_POSTGRES_USER:-authentik}
      - POSTGRES_PASSWORD=${AUTHENTIK_POSTGRES_PASSWORD:-authentik}
    volumes:
      - authentik_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTHENTIK_POSTGRES_USER:-authentik}"]
      interval: 10s
      timeout: 5s
      retries: 10

  authentik-redis:
    image: redis:7-alpine
    container_name: lifelog-authentik-redis
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    volumes:
      - authentik_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  authentik-server:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_IMAGE_TAG:-latest}
    container_name: lifelog-authentik
    command: server
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY:-dev-secret-change-me}
      - AUTHENTIK_POSTGRESQL__HOST=authentik-db
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRES_USER:-authentik}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRES_DB:-authentik}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRES_PASSWORD:-authentik}
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_BOOTSTRAP_PASSWORD:-}
      - AUTHENTIK_BOOTSTRAP_EMAIL=${AUTHENTIK_BOOTSTRAP_EMAIL:-}
    ports:
      - "9002:9000"
      - "9443:9443"
    volumes:
      - authentik_media:/media
      - authentik_templates:/templates
    depends_on:
      - authentik-db
      - authentik-redis
    healthcheck:
      test: ["CMD", "ak", "healthcheck"]
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 60s

  authentik-worker:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_IMAGE_TAG:-latest}
    container_name: lifelog-authentik-worker
    command: worker
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY:-dev-secret-change-me}
      - AUTHENTIK_POSTGRESQL__HOST=authentik-db
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRES_USER:-authentik}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRES_DB:-authentik}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRES_PASSWORD:-authentik}
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
    volumes:
      - authentik_media:/media
      - authentik_templates:/templates
    depends_on:
      - authentik-db
      - authentik-redis

  rustfs:
    image: ${RUSTFS_IMAGE:-rustfs/rustfs:latest}
    container_name: lifelog-rustfs
    ports:
      - "9000:9000"   # S3-compatible API
      - "9001:9001"   # optional console (if enabled by the image)
    environment:
      - RUSTFS_ACCESS_KEY=${S3_ACCESS_KEY_ID:-rustfs}
      - RUSTFS_SECRET_KEY=${S3_SECRET_ACCESS_KEY:-rustfs123}
    volumes:
      - rustfs_data:/data

  qdrant:
    image: qdrant/qdrant:latest
    container_name: lifelog-qdrant
    ports:
      - "6333:6333"   # HTTP API + /metrics
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:6333/collections"]
      interval: 15s
      timeout: 5s
      retries: 10

  flower:
    image: mher/flower:latest
    container_name: lifelog-flower
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis

  celery-exporter:
    image: danihodovic/celery-exporter:latest
    container_name: lifelog-celery-exporter
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    command: ["--broker-url=redis://redis:6379/0"]
    ports:
      - "9808:9808"   # /metrics
    depends_on:
      - redis

  prometheus:
    image: prom/prometheus:latest
    container_name: lifelog-prometheus
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    volumes:
      - ./orchestration/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - celery-exporter
      - qdrant

  grafana:
    image: grafana/grafana:latest
    container_name: lifelog-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

  # API Server (runs migrations on startup)
  api:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: lifelog-api
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-lifelog}
      - POSTGRES_USER=${POSTGRES_USER:-lifelog}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-lifelog}
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-lifelog-items}
      - S3_ENDPOINT_URL=http://rustfs:9000
      - S3_PUBLIC_URL=http://localhost:9000
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-rustfs}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-rustfs123}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_FORCE_PATH_STYLE=true
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-s3}
      - BUCKET_ORIGINALS=${BUCKET_ORIGINALS:-originals}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash-lite}
      - CHAT_MAX_OUTPUT_TOKENS=${CHAT_MAX_OUTPUT_TOKENS:-2048}
      - AGENT_IMAGE_PROVIDER=${AGENT_IMAGE_PROVIDER:-gemini}
      - AGENT_IMAGE_MODEL=${AGENT_IMAGE_MODEL:-gemini-2.5-flash-image}
      - AGENT_IMAGE_TIMEOUT_SECONDS=${AGENT_IMAGE_TIMEOUT_SECONDS:-60}
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-}
      - OIDC_JWKS_URL=${OIDC_JWKS_URL:-}
      - OIDC_AUDIENCE=${OIDC_AUDIENCE:-}
      - OIDC_USER_ID_CLAIM=${OIDC_USER_ID_CLAIM:-}
      - OIDC_EMAIL_CLAIM=${OIDC_EMAIL_CLAIM:-}
      - OIDC_NAME_CLAIM=${OIDC_NAME_CLAIM:-}
      - GOOGLE_PHOTOS_CLIENT_ID=${GOOGLE_PHOTOS_CLIENT_ID:-}
      - GOOGLE_PHOTOS_CLIENT_SECRET=${GOOGLE_PHOTOS_CLIENT_SECRET:-}
      - GOOGLE_PHOTOS_REDIRECT_URI=${GOOGLE_PHOTOS_REDIRECT_URI:-}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-gemini}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-gemini-embedding-001}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-3072}
      - VLM_PROVIDER=${VLM_PROVIDER:-gemini}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Celery Worker
  celery-worker:
    build:
      context: ./services/api
      dockerfile: Dockerfile
    container_name: lifelog-celery-worker
    command: ["uv", "run", "celery", "-A", "app.celery_app.celery_app", "worker", "--loglevel=info"]
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-lifelog}
      - POSTGRES_USER=${POSTGRES_USER:-lifelog}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-lifelog}
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-lifelog-items}
      - S3_ENDPOINT_URL=http://rustfs:9000
      - S3_PUBLIC_URL=http://localhost:9000
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-rustfs}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-rustfs123}
      - S3_REGION=${S3_REGION:-us-east-1}
      - S3_FORCE_PATH_STYLE=true
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-s3}
      - BUCKET_ORIGINALS=${BUCKET_ORIGINALS:-originals}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash-lite}
      - CHAT_MAX_OUTPUT_TOKENS=${CHAT_MAX_OUTPUT_TOKENS:-2048}
      - AGENT_IMAGE_PROVIDER=${AGENT_IMAGE_PROVIDER:-gemini}
      - AGENT_IMAGE_MODEL=${AGENT_IMAGE_MODEL:-gemini-2.5-flash-image}
      - AGENT_IMAGE_TIMEOUT_SECONDS=${AGENT_IMAGE_TIMEOUT_SECONDS:-60}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

volumes:
  pg_data:
  qdrant_data:
  rustfs_data:
  prometheus_data:
  grafana_data:
  authentik_db_data:
  authentik_redis_data:
  authentik_media:
  authentik_templates:
