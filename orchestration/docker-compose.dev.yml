version: "3.9"

services:
  postgres:
    image: postgres:15-alpine
    container_name: lifelog-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-lifelog}
      - POSTGRES_USER=${POSTGRES_USER:-lifelog}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-lifelog}
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-lifelog}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: valkey/valkey:7-alpine
    container_name: lifelog-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD-SHELL", "valkey-cli ping || redis-cli ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rustfs:
    image: ${RUSTFS_IMAGE:-rustfs/rustfs:latest}
    container_name: lifelog-rustfs
    ports:
      - "9000:9000"   # S3-compatible API
      - "9001:9001"   # optional console (if enabled by the image)
    # Adjust env/command to match the RustFS image you use.
    environment:
      - RUSTFS_ACCESS_KEY=${S3_ACCESS_KEY_ID:-rustfs}
      - RUSTFS_SECRET_KEY=${S3_SECRET_ACCESS_KEY:-rustfs123}
    volumes:
      - rustfs_data:/data

  qdrant:
    image: qdrant/qdrant:latest
    container_name: lifelog-qdrant
    ports:
      - "6333:6333"   # HTTP API + /metrics
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:6333/collections"]
      interval: 15s
      timeout: 5s
      retries: 10

  flower:
    image: mher/flower:latest
    container_name: lifelog-flower
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis

  celery-exporter:
    image: danihodovic/celery-exporter:latest
    container_name: lifelog-celery-exporter
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    command: ["--broker-url=redis://redis:6379/0"]
    ports:
      - "9808:9808"   # /metrics
    depends_on:
      - redis

  prometheus:
    image: prom/prometheus:latest
    container_name: lifelog-prometheus
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - celery-exporter
      - qdrant

  grafana:
    image: grafana/grafana:latest
    container_name: lifelog-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

# api:
#   build: ../services/api
#   container_name: lifelog-api
#   env_file: ../.env.dev
#   ports:
#     - "8000:8000"
#   depends_on:
#     - redis
#     - qdrant
#   command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# worker:
#   build: ../services/api
#   container_name: lifelog-worker
#   env_file: ../.env.dev
#   depends_on:
#     - redis
#   command: celery -A app.tasks worker --loglevel=info

# beat:
#   build: ../services/api
#   container_name: lifelog-beat
#   env_file: ../.env.dev
#   depends_on:
#     - redis
#   command: celery -A app.tasks beat --loglevel=info

volumes:
  pg_data:
  qdrant_data:
  rustfs_data:
  prometheus_data:
  grafana_data:
