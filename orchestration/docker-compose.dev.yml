version: "3.9"

services:
  postgres:
    image: postgres:15-alpine
    container_name: lifelog-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-lifelog}
      - POSTGRES_USER=${POSTGRES_USER:-lifelog}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-lifelog}
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-lifelog}"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: lifelog-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: lifelog-qdrant
    ports:
      - "6333:6333"   # HTTP API + /metrics
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:6333/collections"]
      interval: 15s
      timeout: 5s
      retries: 10

  flower:
    image: mher/flower:latest
    container_name: lifelog-flower
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis

  celery-exporter:
    image: danihodovic/celery-exporter:latest
    container_name: lifelog-celery-exporter
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "9808:9808"   # /metrics
    depends_on:
      - redis

  prometheus:
    image: prom/prometheus:latest
    container_name: lifelog-prometheus
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - celery-exporter
      - qdrant

  grafana:
    image: grafana/grafana:latest
    container_name: lifelog-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    ports:
      - "3001:3000"
    depends_on:
      - prometheus

  # api:
  #   build: ../services/api
  #   container_name: lifelog-api
  #   env_file: ../.env.dev
  #   ports:
  #     - "8000:8000"
  #   depends_on:
  #     - redis
  #     - qdrant
  #   command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # worker:
  #   build: ../services/api
  #   container_name: lifelog-worker
  #   env_file: ../.env.dev
  #   depends_on:
  #     - redis
  #   command: celery -A app.tasks worker --loglevel=info

  # beat:
  #   build: ../services/api
  #   container_name: lifelog-beat
  #   env_file: ../.env.dev
  #   depends_on:
  #     - redis
  #   command: celery -A app.tasks beat --loglevel=info

volumes:
  pg_data:
  qdrant_data:
